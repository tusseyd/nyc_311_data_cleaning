) +
labs(
title = "Density Distribution of Positive Durations",
x = "Days (log scale)",
y = "Density"
) +
david_theme()
Sys.sleep(3)
# Find the valley between bimodal peaks
log_dens <- density(log10(positive_data$duration_days), n = 2048)
# Search for valley between 0.1 and 10 days (log10(-1) to log10(1))
valley_region <- log_dens$x > -1 & log_dens$x < 1
valley_idx <- which.min(log_dens$y[valley_region])
valley_cutoff <- 10^log_dens$x[valley_region][valley_idx]
cat(sprintf("\n=== Valley Analysis ===\n"))
cat(sprintf("Valley minimum at: %.3f days\n", valley_cutoff))
# Split data at valley threshold
positive_data[, mode_group := ifelse(duration_days < valley_cutoff, "Fast", "Standard")]
# Characterize each mode
cat("\n=== Mode Characterization ===\n")
print(positive_data[, .(
n = .N,
pct = 100 * .N / nrow(positive_data),
median_days = median(duration_days),
mean_days = mean(duration_days),
p95 = quantile(duration_days, 0.95)
), by = mode_group])
# Analyze by agency - which agencies drive each mode?
cat("\n=== Agency Distribution by Mode ===\n")
print(positive_data[, .N, by = .(agency, mode_group)][
, pct := 100 * N / sum(N), by = agency
][order(agency, mode_group)])
# Create NYPD subset
nypd_data <- positive_data[agency == "NYPD"]
other_data <- positive_data[agency != "NYPD"]
# Calculate NYPD mean
nypd_mean <- mean(nypd_data$duration_days)
# Calculate NYPD median
nypd_median <- median(nypd_data$duration_days)
# NYPD histogram with mean and median lines
p1 <- ggplot(nypd_data, aes(x = duration_days)) +
geom_histogram(bins = 150, fill = "#0072B2", alpha = 0.85, color = "white",
linewidth = 0.05) +
geom_vline(xintercept = nypd_mean, color = "#999999", linewidth = 1.5,
linetype = "dashed") +
annotate("text", x = nypd_mean, y = Inf,
label = sprintf("Mean = %.2f days", nypd_mean),
vjust = 3, hjust = -0.1, color = "#999999", size = 4,
fontface = "bold") +
geom_vline(xintercept = nypd_median, color = "#D55E00", linewidth = 1.5,
linetype = "dotted") +
annotate("text", x = nypd_median, y = Inf,
label = sprintf("Median = %.2f days", nypd_median),
vjust = 3.0, hjust = 1.15, color = "#D55E00", size = 4,
fontface = "bold") +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
labs(
title = "NYPD-only Service Requests with Positive Durations",
subtitle = sprintf("n = %s, Median = %.2f days, Mean = %.2f days",
format(nrow(nypd_data), big.mark = ","),
nypd_median,
nypd_mean),
x = "Days (log scale)",
y = "Count"
) +
david_theme()
print(p1)
Sys.sleep(3)
# Calculate other agencies mean and median
other_mean <- mean(other_data$duration_days)
other_median <- median(other_data$duration_days)
# Other agencies histogram with mean and median lines
p2 <- ggplot(other_data, aes(x = duration_days)) +
geom_histogram(bins = 150, fill = "#009E73", alpha = 0.85, color = "white",
linewidth = 0.05) +
geom_vline(xintercept = other_mean, color = "#999999", linewidth = 1.5,
linetype = "dashed") +
annotate("text", x = other_mean, y = Inf,
label = sprintf("Mean = %.2f days", other_mean),
vjust = 3, hjust = -0.1, color = "#999999", size = 4,
fontface = "bold") +
geom_vline(xintercept = other_median, color = "#D55E00", linewidth = 1.5,
linetype = "dotted") +
annotate("text", x = other_median, y = Inf,
label = sprintf("Median = %.2f days", other_median),
vjust = 3.0, hjust = 1.15, color = "#D55E00", size = 4,
fontface = "bold") +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
labs(
title = "Non-NYPD Service Requests with Positive Durations",
subtitle = sprintf("n = %s, Median = %.2f days, Mean = %.2f days",
format(nrow(other_data), big.mark = ","),
other_median,
other_mean),
x = "Days (log scale)",
y = "Count"
) +
david_theme()
print(p2)
Sys.sleep(3)
# Save individual plots
ggsave(file.path(chart_dir, "nypd_only_positive_durations.pdf"), p1,
width = 13, height = 8.5, units = "in")
ggsave(file.path(chart_dir, "others_only_positive_durations.pdf"), p2,
width = 13, height = 8.5, units = "in")
# Combine data with agency group label
combined_data <- rbind(
nypd_data[, .(duration_days, group = "NYPD")],
other_data[, .(duration_days, group = "Other Agencies")]
)
p_combined <- ggplot(combined_data, aes(x = duration_days, fill = group)) +
geom_histogram(bins = 150, alpha = 0.7, position = "identity",
color = "white", linewidth = 0.1) +
scale_fill_manual(values = c("NYPD" = "#0072B2", "Other Agencies" = "#009E73")) +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
labs(
title = "Bimodal Duration Distribution: NYPD vs Other Agencies",
subtitle = sprintf("NYPD n = %s, Other n = %s",
format(nrow(nypd_data), big.mark = ","),
format(nrow(other_data), big.mark = ",")),
x = "Days (log scale)",
y = "Count",
fill = "Agency Group"
) +
david_theme() +
theme(
legend.position = "inside",
legend.position.inside = c(0.15, 0.85),  # Upper left (x, y from 0-1)
legend.background = element_rect(fill = "white", color = "#999999")
)
print(p_combined)
Sys.sleep(3)
ggsave(file.path(chart_dir, "nypd_vs_others_combined.pdf"), p_combined,
width = 13, height = 8.5, units = "in")
# Set histogram display limits for readability
upper_limit <- 30*3    # Maximum days to display (90 days)
lower_limit <- 2       # Minimum days to display
# Create bounded dataset for plotting
limited_positive_data <- positive_data[
duration_days >= lower_limit & duration_days <= upper_limit
]
# Generate summary statistics
cat("\n=== Summary of duration_days ===\n")
print(summary(positive_data$duration_days))
# Count records within plotting bounds
n_plotted <- nrow(limited_positive_data)
plot_histogram(
DT         = positive_data,
value_col  = "duration_days",
title      = sprintf("Positive Duration Distribution (<= %s days)",
upper_limit),
x_label    = "Duration (days)",
add_labels = TRUE,
chart_dir  = chart_dir,
filename   = "positive_duration_histogram.pdf",
bins       = 300,
alpha      = 0.8,
outlier_percentile = 1.0,
add_stats  = TRUE,
width      = 13,
height     = 8.5,
xlim       = c(0, upper_limit)
)
# ==============================================================================
# SECTION 2: NEGATIVE DURATION ANALYSIS
# ==============================================================================
# Analyze service requests with negative durations (data quality issues)
# Negative durations indicate closed_date occurs before created_date
cat("\n=== ANALYZING NEGATIVE DURATIONS ===\n")
# Filter to negative duration records
negative_data <- d311[duration_days < 0 & !is.na(duration_days)]
# Set histogram limits for negative values
upper_limit_neg <- 0      # Less negative (closer to zero)
lower_limit_neg <- -365   # More negative (further from zero)
# Create bounded dataset for plotting
limited_negative_data <- negative_data[
duration_days >= lower_limit_neg & duration_days <= upper_limit_neg
]
# Generate summary statistics
summary(negative_data$duration_day)
# Count records within plotting bounds
n_plotted_neg <- nrow(limited_negative_data)
plot_histogram(
DT         = limited_negative_data,
value_col  = "duration_days",
# Titles and labels
title      = sprintf("Negative Duration Distribution (%d to %d days)",
lower_limit_neg, upper_limit_neg),
x_label    = "Duration (days)",
chart_dir  = chart_dir,
filename   = "negative_duration_histogram.pdf",
add_labels = FALSE,        # <-- ADD THIS
# Visual appearance
bins       = 100,
fill_color = "#D55E00",
alpha      = 0.7,
# Bounds
xlim       = c(lower_limit_neg, upper_limit_neg),
outlier_percentile = 1.0,   # don’t trim — you’re bounding manually
# Stats & output
add_stats  = TRUE,
width      = 13,
height     = 8.5
)
plot_result <- plot_boxplot(
DT        = limited_negative_data,
value_col = duration_days,
by_col    = agency,
chart_dir = chart_dir,
filename  = "negative_duration_SR_boxplot.pdf",
title     = " Negative Duration (days) by agency",
top_n     = 30,
y_axis_tick_size = 10,
order_by  = "count",
flip      = TRUE,
x_scale_type = "pseudo_log",
x_limits = c(lower_limit, upper_limit),
min_count = 5,  # FIXED: was min_agency_obs (which defaults to 1)
jitter_size = 1.3,
jitter_alpha = 0.55,
outlier_size = 1.4,
count_label_hjust = label_hjust,
show_count_labels = show_count_labels
)
create_violin_chart(
dataset = limited_negative_data,
x_axis_field = "duration_days",
chart_directory = chart_dir,
chart_file_name = "negative_duration_SR_violin.pdf",
chart_title = "Distribution of Negative Duration Days"
)
# ==============================================================================
# SECTION 3: SHORT DURATION ANALYSIS & THRESHOLD DETERMINATION
# ==============================================================================
# Analyze very short durations to identify suspicious patterns
# Determines statistical threshold for flagging anomalously short durations
cat("\n=== ANALYZING SHORT DURATIONS & SETTING THRESHOLDS ===\n")
# Run comprehensive skewed duration analysis
skewed_result <- analyze_skewed_durations(
DT = d311,
duration_col = "duration_days",
minimum_cutoff_sec = 2,
upper_cutoff_sec = 60*60*24*2L,  # 2 days in seconds
print_summary = TRUE,
create_plots = TRUE,
chart_dir = chart_dir
)
# Extract the LogNormal 3-standard-deviation threshold
threshold <- skewed_result$thresholds$log_3sd_lower
threshold_numeric <- round(as.numeric(threshold), 0)
# Create detailed histogram with threshold visualization
plot_duration_histogram(
DT = d311,
duration_col = "duration_days",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value = 90,           # Focus on first 90 seconds
min_value = 2L,
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
# Display threshold value
cat("LogNormal_3SD threshold:", threshold_numeric, "seconds\n")
# ==============================================================================
# SECTION 4: COMPREHENSIVE DURATION CATEGORY ANALYSIS
# ==============================================================================
# Systematic analysis of all duration categories:
# - Negative (small, large, extreme)
# - Zero durations
# - Near-zero (seconds-level)
# - One-second durations
# - Positive (small, large, extreme)
cat("\n=== COMPREHENSIVE DURATION CATEGORY ANALYSIS ===\n")
duraton_analysis <- analyze_duration_QA(d311,
chart_dir = chart_dir)
# Call with the 2019 file path
result <- summarize_backlog(
DT = d311,
data_dir = data_dir
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/summarize_backlog.R")
0
0
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/summarize_backlog.R")
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/summarize_backlog.R")
# Call with the 2019 file path
result <- summarize_backlog(
DT = d311,
data_dir = data_dir
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/plot_duration_histogram.R")
# Create detailed histogram with threshold visualization
plot_duration_histogram(
DT = d311,
duration_col = "duration_days",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value = 90,           # Focus on first 90 seconds
min_value = 2L,
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
names(d311)
# Create detailed histogram with threshold visualization
plot_duration_histogram(
DT = d311,
#  duration_col = "duration_days",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value = 90,           # Focus on first 90 seconds
min_value = 2L,
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
# Create detailed histogram with threshold visualization
plot_duration_histogram(
DT = d311,
#  duration_col = "duration_days",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value <- 90 / 86400,      # 0.001041667 days (90 seconds)
min_value <- 2 / 86400,       # 0.00002314815 days (2 seconds)
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/plot_duration_histogram.R")
# Add duration_sec column
d311[, duration_sec := duration_days * 86400]
plot_duration_histogram(
DT = d311,
#  duration_col = "duration_days",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value <- 90,      # 0.001041667 days (90 seconds)
min_value <- 2,       # 0.00002314815 days (2 seconds)
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
# Add duration_sec column
d311[, duration_sec := duration_days * 86400]
plot_duration_histogram(
DT = d311,
duration_col = "duration_days",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value <- 90,      # 0.001041667 days (90 seconds)
min_value <- 2,       # 0.00002314815 days (2 seconds)
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/plot_duration_histogram.R")
plot_duration_histogram(
DT = d311,
duration_col = "duration_days",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value <- 90,      # 0.001041667 days (90 seconds)
min_value <- 2,       # 0.00002314815 days (2 seconds)
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
plot_duration_histogram(
DT = your_data,
duration_col = "duration_sec",  # Use seconds
min_value = 2,                   # 2 seconds
max_value = 90,                  # 90 seconds
chart_dir = chart_dir,
filename = "duration_histogram.pdf"
)
plot_duration_histogram(
DT = d311,
duration_col = "duration_sec",  # Use seconds
min_value = 2,                   # 2 seconds
max_value = 90,                  # 90 seconds
chart_dir = chart_dir,
filename = "duration_histogram.pdf"
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/plot_duration_histogram.R")
plot_duration_histogram(
DT = d311,
duration_col = "duration_sec",  # Use seconds
min_value = 2,                   # 2 seconds
max_value = 90,                  # 90 seconds
chart_dir = chart_dir,
filename = "duration_histogram.pdf"
)
plot_duration_histogram(
DT = d311,
duration_col = "duration_sec",  # Use seconds
min_value = 2,                   # 2 seconds
max_value = 90,                  # 90 seconds
chart_dir = chart_dir,
filename = "duration_histogram"
)
# Create detailed histogram with threshold visualization
plot_duration_histogram(
DT = d311,
duration_col = "duration_sec",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value = 90,           # Focus on first 90 seconds
min_value = 2L,
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
# Add duration_sec column
d311[, duration_sec := duration_days * 86400]
# Create detailed histogram with threshold visualization
plot_duration_histogram(
DT = d311,
duration_col = "duration_sec",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value = 90,           # Focus on first 90 seconds
min_value = 2L,
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/plot_duration_histogram.R")
# Add duration_sec column
d311[, duration_sec := duration_days * 86400]
# Create detailed histogram with threshold visualization
plot_duration_histogram(
DT = d311,
duration_col = "duration_sec",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value = 90,           # Focus on first 90 seconds
min_value = 2L,
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
cat("\n=== ANALYZING SHORT DURATIONS & SETTING THRESHOLDS ===\n")
# Run comprehensive skewed duration analysis
skewed_result <- analyze_skewed_durations(
DT = d311,
duration_col = "duration_days",
minimum_cutoff_sec = 2,
upper_cutoff_sec = 60*60*24*2L,  # 2 days in seconds
print_summary = TRUE,
create_plots = TRUE,
chart_dir = chart_dir
)
# Extract the LogNormal 3-standard-deviation threshold
threshold <- skewed_result$thresholds$log_3sd_lower
threshold_numeric <- round(as.numeric(threshold), 0)
# Create detailed histogram with threshold visualization
# Add duration_sec column
d311[, duration_sec := duration_days * 86400]
# Create detailed histogram with threshold visualization
plot_duration_histogram(
DT = d311,
duration_col = "duration_sec",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value = 90,           # Focus on first 90 seconds
min_value = 2L,
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/analyze_skewed_durations.R")
cat("\n=== ANALYZING SHORT DURATIONS & SETTING THRESHOLDS ===\n")
# Add duration_sec column
d311[, duration_sec := duration_days * 86400]
# Run comprehensive skewed duration analysis
skewed_result <- analyze_skewed_durations(
DT = d311,
duration_col = "duration_sec",
minimum_cutoff_sec = 2,
upper_cutoff_sec = 60*60*24*2L,  # 2 days in seconds
print_summary = TRUE,
create_plots = TRUE,
chart_dir = chart_dir
)
# Extract the LogNormal 3-standard-deviation threshold
threshold <- skewed_result$thresholds$log_3sd_lower
threshold_numeric <- round(as.numeric(threshold), 0)
# Create detailed histogram with threshold visualization
# Create detailed histogram with threshold visualization
plot_duration_histogram(
DT = d311,
duration_col = "duration_sec",
bin_width = 1,
x_label_skip = 2,         # Show every 2nd x-axis label
x_axis_angle = 45,        # Rotate labels for readability
max_value = 90,           # Focus on first 90 seconds
min_value = 2L,
threshold_numeric = threshold_numeric,
chart_dir = chart_dir
)
# Display threshold value
cat("LogNormal_3SD threshold:", threshold_numeric, "seconds\n")
