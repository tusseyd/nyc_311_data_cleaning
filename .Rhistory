cat("\n=== Hartigan's Dip Test for Multimodality ===\n")
print(dip.test(log10(positive_data$duration_days)))
# 2. Find the valley/separation point
density_est <- density(log10(positive_data$duration_days), n = 2048)
plot(density_est)
# Density plot
p1 <- ggplot(positive_data, aes(x = duration_days)) +
geom_density(fill = "#0072B2", alpha = 0.7, color = "#0072B2") +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
labs(
title = "Density Distribution of Positive Durations",
x = "Days (log scale)",
y = "Density"
) +
david_theme()
print(p1)
ggsave(
filename = file.path(chart_dir, "All-Agency density_positive_durations.pdf"),
plot = p1,
width = 10,
height = 6,
dpi = 300
)
Sys.sleep(3)
# Calculate mean and median
mean_duration <- mean(positive_data$duration_days)
median_duration <- median(positive_data$duration_days)
# Histogram showing counts with mean and median lines
p2 <- ggplot(positive_data, aes(x = duration_days)) +
geom_histogram(fill = "#0072B2", color = "white", bins = 200) +
geom_vline(aes(xintercept = median_duration),
color = "#D55E00", linewidth = 1, linetype = "solid") +
geom_vline(aes(xintercept = mean_duration),
color = "grey20", linewidth = 1, linetype = "dashed") +
annotate("text", x = median_duration, y = Inf,
label = sprintf("Median: %.2f days", median_duration),
hjust = -0.1, vjust = 1.5, color = "#D55E00", size = 3.5) +
annotate("text", x = mean_duration, y = Inf,
label = sprintf("Mean: %.2f days", mean_duration),
hjust = -0.1, vjust = 3, color = "grey20", size = 3.5) +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
scale_y_continuous(labels = scales::comma) +
labs(
title = "Distribution of Positive Durations - All Agencies",
x = "Days (log scale)",
y = "Count"
) +
david_theme()
print(p2)
ggsave(
filename = file.path(chart_dir, "All-Agencies histogram_positive_durations.pdf"),
plot = p2,
width = 10,
height = 6,
dpi = 300
)
# Histogram showing counts with mean and median lines
p2 <- ggplot(positive_data, aes(x = duration_days)) +
geom_histogram(fill = "#0072B2", color = "white", bins = 200) +
geom_vline(aes(xintercept = median_duration),
color = "#D55E00", linewidth = 1, linetype = "solid") +
geom_vline(aes(xintercept = mean_duration),
color = "grey20", linewidth = 1, linetype = "dashed") +
annotate("text", x = median_duration, y = Inf,
label = sprintf("Median: %.2f days", median_duration),
hjust = -0.1, vjust = 1.5, color = "#D55E00", size = 3.5) +
annotate("text", x = mean_duration, y = Inf,
label = sprintf("Mean: %.2f days", mean_duration),
hjust = -0.1, vjust = 3, color = "grey20", size = 3.5) +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
scale_y_continuous(labels = scales::comma) +
labs(
title = "Distribution of Positive Durations - All Agencies",
x = "Days (log scale)",
y = "Count"
) +
david_theme()
print(p2)
Sys.sleep(3)
ggsave(
filename = file.path(chart_dir, "All-Agencies histogram_positive_durations.pdf"),
plot = p2,
width = 10,
height = 6,
dpi = 300
)
# Find the valley between bimodal peaks
log_dens <- density(log10(positive_data$duration_days), n = 2048)
# Search for valley between 0.1 and 10 days (log10(-1) to log10(1))
valley_region <- log_dens$x > -1 & log_dens$x < 1
valley_idx <- which.min(log_dens$y[valley_region])
valley_cutoff <- 10^log_dens$x[valley_region][valley_idx]
cat(sprintf("\n=== Valley Analysis ===\n"))
cat(sprintf("Valley minimum at: %.3f days\n", valley_cutoff))
# Split data at valley threshold
positive_data[, mode_group := ifelse(duration_days < valley_cutoff, "Fast", "Standard")]
# Characterize each mode
cat("\n=== Mode Characterization ===\n")
print(positive_data[, .(
n = .N,
pct = 100 * .N / nrow(positive_data),
median_days = median(duration_days),
mean_days = mean(duration_days),
p95 = quantile(duration_days, 0.95)
), by = mode_group])
# Analyze by agency - which agencies drive each mode?
cat("\n=== Agency Distribution by Mode ===\n")
print(positive_data[, .N, by = .(agency, mode_group)][
, pct := 100 * N / sum(N), by = agency
][order(agency, mode_group)])
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/jds_datacleansings.R")
yearly_bar_chart <- plot_annual_counts_with_projection(
DT = d311,
created_col = "created_date",
estimate_flag = FALSE,
estimate_date = projection_date,
estimate_value = projection_SR_count,
chart_dir = chart_dir,
filename = "annual_trend_with_projection_bar_chart.pdf",
title = "NYC 311 Service Requests by Year",
subtitle = "w/2025 projection",
include_projection_in_growth = TRUE,
include_projection_in_stats  = TRUE,
show_projection_bar = TRUE
)
yearly_bar_chart <- plot_annual_counts_with_projection(
DT = d311,
created_col = "created_date",
estimate_flag = TRUE,
estimate_date = projection_date,
estimate_value = projection_SR_count,
chart_dir = chart_dir,
filename = "annual_trend_with_projection_bar_chart.pdf",
title = "NYC 311 Service Requests by Year",
subtitle = "w/2025 projection",
include_projection_in_growth = TRUE,
include_projection_in_stats  = TRUE,
show_projection_bar = TRUE
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/misc_programs/check_for_missing_duration_seconds.R")
cat("\n=== ANALYZING POSITIVE DURATIONS ===\n")
# Filter to positive duration records only
positive_data <- d311[duration_days > 0 & !is.na(duration_days),
.(created_date, closed_date, duration_days,
complaint_type, agency)]
# Calculate statistics
n_total <- nrow(positive_data)
mean_dur <- mean(positive_data$duration_days, na.rm = TRUE)
median_dur <- median(positive_data$duration_days, na.rm = TRUE)
# Create the plot
positive_all_agencies <- ggplot(positive_data, aes(x = duration_days)) +
geom_histogram(bins = 200, fill = "#0072B2", color = "white") +
geom_vline(xintercept = mean_dur, color = "grey20",
linetype = "dashed", linewidth = 1.4) +
geom_vline(xintercept = median_dur, color = "#D55E00",
linetype = "dotted", linewidth = 1.5) +
scale_x_log10(
labels = comma,
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000)
) +
labs(
x = "Days (log scale)",
y = "Count",
title = "Distribution of Positive SR Durations - All City Agencies",
subtitle = paste0("n = ", format(n_total, big.mark = ","))
) +
annotate("text", x = mean_dur * 3, y = Inf,
label = paste("Mean =", round(mean_dur, 2), "days"),
vjust = 2, hjust = 0.23, color = "grey20", size = 4.5) +
annotate("text", x = median_dur * 3, y = Inf,
label = paste("Median =", round(median_dur, 2), "days"),
vjust = 3.5, hjust = 0.23, color = "#D55E00", size = 4.5) +
david_theme() +
theme(
plot.title = element_text(hjust = 0.5),
plot.subtitle = element_text(hjust = 0),  # Left-align subtitle
panel.grid.minor = element_blank()
)
print(positive_all_agencies)
Sys.sleep(3)
# Save to chart directory
ggsave(file.path(chart_dir, "positive_all_agencies.pdf"),
plot = positive_all_agencies,
width = 13, height = 8.5, dpi = 300)
# Create the summary and transpose it
summary_stats <- positive_data[, .(
n = .N,
median_days = median(duration_days),
mean_days = mean(duration_days),
sd_days = sd(duration_days),
skewness = skewness(duration_days),
p95 = quantile(duration_days, 0.95),
p99 = quantile(duration_days, 0.99),
max_days = max(duration_days)
)]
cat("\n=== Summary Statistics ===\n")
print(data.table(
Statistic = c("N", "Median (days)", "Mean (days)", "Std Dev (days)",
"Skewness", "95th percentile", "99th percentile", "Maximum (days)"),
Value = sprintf("%.4f", as.numeric(summary_stats[1,]))
))
cat("\n=== Bowley Skewness ===\n")
print(positive_data[, {
q <- quantile(duration_days, c(0.25, 0.5, 0.75), na.rm = TRUE)
.(bowley_skew = round((q[3] + q[1] - 2*q[2]) / (q[3] - q[1]), 4))
}])
cat("\n=== Hartigan's Dip Test for Multimodality ===\n")
print(dip.test(log10(positive_data$duration_days)))
# 2. Find the valley/separation point
density_est <- density(log10(positive_data$duration_days), n = 2048)
plot(density_est)
# Density plot
p1 <- ggplot(positive_data, aes(x = duration_days)) +
geom_density(fill = "#0072B2", alpha = 0.7, color = "#0072B2") +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
labs(
title = "Density Distribution of Positive Durations",
x = "Days (log scale)",
y = "Density"
) +
david_theme()
print(p1)
ggsave(
filename = file.path(chart_dir, "All-Agency density_positive_durations.pdf"),
plot = p1,
width = 10,
height = 6,
dpi = 300
)
Sys.sleep(3)
# Calculate mean and median
mean_duration <- mean(positive_data$duration_days)
median_duration <- median(positive_data$duration_days)
# Histogram showing counts with mean and median lines
p2 <- ggplot(positive_data, aes(x = duration_days)) +
geom_histogram(fill = "#0072B2", color = "white", bins = 200) +
geom_vline(aes(xintercept = median_duration),
color = "#D55E00", linewidth = 1, linetype = "solid") +
geom_vline(aes(xintercept = mean_duration),
color = "grey20", linewidth = 1, linetype = "dashed") +
annotate("text", x = median_duration, y = Inf,
label = sprintf("Median: %.2f days", median_duration),
hjust = -0.1, vjust = 1.5, color = "#D55E00", size = 3.5) +
annotate("text", x = mean_duration, y = Inf,
label = sprintf("Mean: %.2f days", mean_duration),
hjust = -0.1, vjust = 3, color = "grey20", size = 3.5) +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
scale_y_continuous(labels = scales::comma) +
labs(
title = "Distribution of Positive Durations - All Agencies",
x = "Days (log scale)",
y = "Count"
) +
david_theme()
print(p2)
Sys.sleep(3)
ggsave(
filename = file.path(chart_dir, "All-Agencies histogram_positive_durations.pdf"),
plot = p2,
width = 10,
height = 6,
dpi = 300
)
# Find the valley between bimodal peaks
log_dens <- density(log10(positive_data$duration_days), n = 2048)
# Search for valley between 0.1 and 10 days (log10(-1) to log10(1))
valley_region <- log_dens$x > -1 & log_dens$x < 1
valley_idx <- which.min(log_dens$y[valley_region])
valley_cutoff <- 10^log_dens$x[valley_region][valley_idx]
cat(sprintf("\n=== Valley Analysis ===\n"))
cat(sprintf("Valley minimum at: %.3f days\n", valley_cutoff))
# Split data at valley threshold
positive_data[, mode_group := ifelse(duration_days < valley_cutoff, "Fast", "Standard")]
# Characterize each mode
cat("\n=== Mode Characterization ===\n")
print(positive_data[, .(
n = .N,
pct = 100 * .N / nrow(positive_data),
median_days = median(duration_days),
mean_days = mean(duration_days),
p95 = quantile(duration_days, 0.95)
), by = mode_group])
# Analyze by agency - which agencies drive each mode?
cat("\n=== Agency Distribution by Mode ===\n")
print(positive_data[, .N, by = .(agency, mode_group)][
, pct := 100 * N / sum(N), by = agency
][order(agency, mode_group)])
# Create NYPD subset
nypd_data <- positive_data[agency == "NYPD"]
other_data <- positive_data[agency != "NYPD"]
# Calculate NYPD mean
nypd_mean <- mean(nypd_data$duration_days)
# Calculate NYPD median
nypd_median <- median(nypd_data$duration_days)
# NYPD histogram with mean and median lines
p3 <- ggplot(nypd_data, aes(x = duration_days)) +
geom_histogram(bins = 150, fill = "#0072B2", alpha = 0.85, color = "white",
linewidth = 0.05) +
geom_vline(xintercept = nypd_mean, color = "grey20", linewidth = 1.5,
linetype = "dashed") +
annotate("text", x = nypd_mean, y = Inf,
label = sprintf("Mean = %.2f days", nypd_mean),
vjust = 3, hjust = -0.1, color = "grey20", size = 4,
fontface = "bold") +
geom_vline(xintercept = nypd_median, color = "#D55E00", linewidth = 1.5,
linetype = "dotted") +
annotate("text", x = nypd_median, y = Inf,
label = sprintf("Median = %.2f days", nypd_median),
vjust = 3.0, hjust = 1.15, color = "#D55E00", size = 4,
fontface = "bold") +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
labs(
title = "NYPD-only Service Requests with Positive Durations",
subtitle = sprintf("n = %s, Median = %.2f days, Mean = %.2f days",
format(nrow(nypd_data), big.mark = ","),
nypd_median,
nypd_mean),
x = "Days (log scale)",
y = "Count"
) +
david_theme()
print(p1)
Sys.sleep(3)
# Calculate other agencies mean and median
other_mean <- mean(other_data$duration_days)
other_median <- median(other_data$duration_days)
# Other agencies histogram with mean and median lines
p4 <- ggplot(other_data, aes(x = duration_days)) +
geom_histogram(bins = 150, fill = "#009E73", alpha = 0.85, color = "white",
linewidth = 0.05) +
geom_vline(xintercept = other_mean, color = "#999999", linewidth = 1.5,
linetype = "dashed") +
annotate("text", x = other_mean, y = Inf,
label = sprintf("Mean = %.2f days", other_mean),
vjust = 3, hjust = -0.1, color = "#999999", size = 4,
fontface = "bold") +
geom_vline(xintercept = other_median, color = "#D55E00", linewidth = 1.5,
linetype = "dotted") +
annotate("text", x = other_median, y = Inf,
label = sprintf("Median = %.2f days", other_median),
vjust = 3.0, hjust = 1.15, color = "#D55E00", size = 4,
fontface = "bold") +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
labs(
title = "Non-NYPD Service Requests with Positive Durations",
subtitle = sprintf("n = %s, Median = %.2f days, Mean = %.2f days",
format(nrow(other_data), big.mark = ","),
other_median,
other_mean),
x = "Days (log scale)",
y = "Count"
) +
david_theme()
print(p2)
Sys.sleep(3)
# Save individual plots
ggsave(file.path(chart_dir, "nypd_only_positive_durations.pdf"), p3,
width = 13, height = 8.5, units = "in")
ggsave(file.path(chart_dir, "others_only_positive_durations.pdf"), p4,
width = 13, height = 8.5, units = "in")
# Combine data with agency group label
combined_data <- rbind(
nypd_data[, .(duration_days, group = "NYPD")],
other_data[, .(duration_days, group = "Other Agencies")]
)
p_combined <- ggplot(combined_data, aes(x = duration_days, fill = group)) +
geom_histogram(bins = 150, alpha = 0.6, position = "identity",
color = "white", linewidth = 0.1) +
scale_fill_manual(values = c("NYPD" = "#0072B2", "Other Agencies" = "#009E73")) +
scale_x_log10(
breaks = c(0.001, 0.01, 0.1, 1, 10, 100, 1000),
labels = c("0.001", "0.01", "0.1", "1", "10", "100", "1,000")
) +
labs(
title = "Bimodal Duration Distribution: NYPD vs Other Agencies",
subtitle = sprintf("NYPD n = %s, Other n = %s",
format(nrow(nypd_data), big.mark = ","),
format(nrow(other_data), big.mark = ",")),
x = "Days (log scale)",
y = "Count",
fill = "Agency Group"
) +
david_theme() +
theme(
legend.position = "inside",
legend.position.inside = c(0.15, 0.85),  # Upper left (x, y from 0-1)
legend.background = element_rect(fill = "white", color = "#999999")
)
print(p_combined)
Sys.sleep(3)
ggsave(file.path(chart_dir, "nypd_vs_others_combined.pdf"), p_combined,
width = 13, height = 8.5, units = "in")
# Set histogram display limits for readability
upper_limit <- 30*3    # Maximum days to display (90 days)
lower_limit <- 2       # Minimum days to display
# Create bounded dataset for plotting
limited_positive_data <- positive_data[
duration_days >= lower_limit & duration_days <= upper_limit
]
# Generate summary statistics
cat("\n=== Summary of duration_days ===\n")
print(summary(positive_data$duration_days))
# Count records within plotting bounds
n_plotted <- nrow(limited_positive_data)
plot_histogram(
DT         = positive_data,
value_col  = "duration_days",
title      = sprintf("Positive Duration Distribution (<= %s days)",
upper_limit),
x_label    = "Duration (days)",
add_labels = TRUE,
chart_dir  = chart_dir,
filename   = "positive_duration_histogram.pdf",
bins       = 300,
alpha      = 0.8,
outlier_percentile = 1.0,
add_stats  = TRUE,
width      = 13,
height     = 8.5,
xlim       = c(0, upper_limit)
)
# ==============================================================================
# SECTION 4: COMPREHENSIVE DURATION CATEGORY ANALYSIS
# ==============================================================================
# Systematic analysis of all duration categories:
# - Negative (small, large, extreme)
# - Zero durations
# - Near-zero (seconds-level)
# - One-second durations
# - Positive (small, large, extreme)
cat("\n=== COMPREHENSIVE DURATION CATEGORY ANALYSIS ===\n")
duraton_analysis <- analyze_duration_QA(d311,
chart_dir = chart_dir)
# ==============================================================================
# SECTION 5: RESPONSE TIMES BY COMPLAINT TYPE
# ==============================================================================
cat("\n=== RESPONSE TIMES BY COMPLAINT CATEGORY ANALYSIS ===\n")
# Exclude durations <= 28 seconds (in days) and > 365* N days (typically 10 yrs)
complaint_stats <- summarize_complaint_response(
d311,
min_records = 100,
lower_exclusion_limit = 0.00032407,
upper_exclusion_limit = 365*10
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/jds_datacleansings.R")
# ---- Console output: Exclusion summary ----
cat("\n=== Complaint Type Response Time Summary ===\n")
cat("\n=== RESPONSE TIMES BY COMPLAINT CATEGORY ANALYSIS ===\n")
# Exclude durations <= 28 seconds (in days) and > 365* N days (typically 10 yrs)
complaint_stats <- summarize_complaint_response(
d311,
min_records = 100,
lower_exclusion_limit = 0.00032407,
upper_exclusion_limit = 365*10
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/summarize_complaint_response.R")
cat("\n=== RESPONSE TIMES BY COMPLAINT CATEGORY ANALYSIS ===\n")
# Exclude durations <= 28 seconds (in days) and > 365* N days (typically 10 yrs)
complaint_stats <- summarize_complaint_response(
d311,
min_records = 100,
lower_exclusion_limit = 0.00032407,
upper_exclusion_limit = 365*10
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/summarize_complaint_response.R")
complaint_stats <- summarize_complaint_response(
d311,
min_records = 100,
lower_exclusion_limit = 0.00032407,
upper_exclusion_limit = 365*10
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/functions/summarize_complaint_response.R")
complaint_stats <- summarize_complaint_response(
d311,
min_records = 100,
lower_exclusion_limit = 0.00032407,
upper_exclusion_limit = 365*10
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/misc_programs/count_lines_of_code.R")
code_dir
base_dir <- file.path(
"C:",
"Users",
"David",
"OneDrive",
"Documents",
"datacleaningproject",
"journal_of_data_science",
"nyc_311_data_cleaning"
)
source("~/datacleaningproject/journal_of_data_science/nyc_311_data_cleaning/code/misc_programs/count_lines_of_code.R")
